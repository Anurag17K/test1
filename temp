from django.shortcuts import render, redirect
from django.contrib import messages
from django.contrib.auth.models import User
import boto3
import os
from datetime import datetime, date
import uuid
import bcrypt
from inventory_lib.logic import InventoryLogic
from .models import UserAction

# ---------------- DynamoDB Setup ----------------
dynamodb = boto3.resource('dynamodb', region_name='us-east-1')
inventory_table = dynamodb.Table('Inventory')
users_table = dynamodb.Table('Users')
logic = InventoryLogic()

# ---------------- Helper Functions ----------------
def upload_to_s3(file_obj, filename):
    s3 = boto3.client('s3', region_name='us-east-1')
    bucket_name = 'smartinventory-tejal'
    s3.upload_fileobj(file_obj, bucket_name, f'images/{filename}')
    return f'https://{bucket_name}.s3.amazonaws.com/images/{filename}'

def login_required_dynamodb(view_func):
    def wrapper(request, *args, **kwargs):
        if 'username' not in request.session:
            return redirect('login')
        return view_func(request, *args, **kwargs)
    return wrapper

def log_action_sqlite(user_obj, action, item_id=None, details=None):
    UserAction.objects.create(
        user=user_obj,
        action_type=action,
        item_id=item_id,
        details=details
    )

# ---------------- Auth ----------------
def signup(request):
    if request.method == 'POST':
        username = request.POST['username'].strip()
        password = request.POST['password'].strip()

        resp = users_table.get_item(Key={'username': username})
        existing = resp.get('Item') if isinstance(resp, dict) else None

        if existing:
            messages.error(request, 'Username already taken.')
        else:
            password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()
            users_table.put_item(Item={
                'username': username,
                'password_hash': password_hash,
                'created_at': datetime.utcnow().isoformat()
            })
            user_obj, _ = User.objects.get_or_create(username=username)
            messages.success(request, 'Account created. Please log in.')
            return redirect('login')

    return render(request, 'signup.html')

def user_login(request):
    if request.method == 'POST':
        username = request.POST['username'].strip()
        password = request.POST['password'].strip()

        resp = users_table.get_item(Key={'username': username})
        user = resp.get('Item') if isinstance(resp, dict) else None

        if user and bcrypt.checkpw(password.encode(), user['password_hash'].encode()):
            request.session['username'] = username
            user_obj = User.objects.get(username=username)
            log_action_sqlite(user_obj, 'login')
            return redirect('dashboard')
        else:
            messages.error(request, 'Invalid username or password.')

    return render(request, 'login.html')

def user_logout(request):
    username = request.session.get('username')
    if username:
        user_obj = User.objects.get(username=username)
        log_action_sqlite(user_obj, 'logout')

    request.session.flush()
    return redirect('login')

# ---------------- Dashboard ----------------
@login_required_dynamodb
def dashboard(request):
    result = {}
    triggered = False
    notification_sent = False

    username = request.session.get('username')
    user_obj = User.objects.get(username=username)

    if request.method == 'POST':

        # ------------------------------------------
        # FIX: Remove unwanted hidden “health” field
        # ------------------------------------------
        post_data = request.POST.copy()
        if "health" in post_data:
            del post_data["health"]

        action = post_data.get('action', '').strip()
        item_id = post_data.get('item_id', '').strip()
        item_name = post_data.get('item_name', '').strip()

        # ---------- Quick Stock Check ----------
        if action == 'check_stock':
            quantity, threshold, expiry_days = 0, 10, None

            if item_id:
                resp = inventory_table.get_item(Key={'item_id': item_id})
                item = resp.get('Item') if isinstance(resp, dict) else None

                if isinstance(item, dict):
                    quantity = int(item.get('quantity', 0))
                    threshold = int(item.get('threshold', 10))
                    item_name = item.get('name', item_name)

                    # expiry
                    expiry_str = item.get('expiry_date')
                    if expiry_str:
                        try:
                            expiry_dt = datetime.strptime(expiry_str, '%Y-%m-%d').date()
                            expiry_days = (expiry_dt - date.today()).days
                        except Exception:
                            expiry_days = int(item.get('expiry_days', 0)) if item.get('expiry_days') else None

            triggered = logic.is_low_stock(quantity, threshold)
            health = logic.health_score(quantity, threshold, expiry_days)

            result.update({
                'item_name': item_name,
                'item_id': item_id,
                'quantity': quantity,
                'threshold': threshold,
                'is_low_stock': triggered,
                'expiry_days': expiry_days,
                'health_score_value': health.get('score'),
                'health_color': health.get('color'),
            })

            log_action_sqlite(user_obj, 'check_stock', item_id)

        # ---------- Detailed Inventory Analysis ----------
        elif action == 'check_inventory':

            if not item_id:
                result['error'] = "Item ID is required."
                return render(request, 'dashboard.html', {'result': result})

            resp = inventory_table.get_item(Key={'item_id': item_id})
            item = resp.get('Item') if isinstance(resp, dict) else None

            if not isinstance(item, dict):
                result['error'] = f"Item {item_id} not found."
                return render(request, 'dashboard.html', {'result': result})

            quantity = int(item.get('quantity', 0))
            threshold = int(item.get('threshold', 10))
            min_required = int(item.get('min_required', 0))
            max_capacity = int(item.get('max_capacity', 0))
            monthly_sales = int(item.get('monthly_sales', 0))
            next_shipment_days = int(item.get('next_shipment_days', 0))

            expiry_days = None
            expiry_str = item.get('expiry_date')

            if expiry_str:
                try:
                    expiry_dt = datetime.strptime(expiry_str, '%Y-%m-%d').date()
                    expiry_days = (expiry_dt - date.today()).days
                except Exception:
                    expiry_days = int(item.get('expiry_days', 0)) if item.get('expiry_days') else None

            triggered = logic.is_low_stock(quantity, threshold)
            health = logic.health_score(quantity, threshold, expiry_days)

            result.update({
                'item_name': item.get('name', ''),
                'item_id': item_id,
                'quantity': quantity,
                'threshold': threshold,
                'min_required': min_required,
                'max_capacity': max_capacity,
                'monthly_sales': monthly_sales,
                'next_shipment_days': next_shipment_days,
                'expiry_days': expiry_days,
                'is_low_stock': triggered,
                'reorder_quantity': logic.reorder_quantity(quantity, min_required, max_capacity),
                'classification': logic.classify_item(monthly_sales),
                'turnover_rate': logic.turnover_rate(monthly_sales * 10, quantity),
                'urgent_restock': logic.needs_restock_urgently(quantity, threshold, next_shipment_days),
                'health_score_value': health.get('score'),
                'health_color': health.get('color'),
            })

            log_action_sqlite(user_obj, 'check_inventory', item_id)

    return render(request, 'dashboard.html', {
        'result': result,
        'triggered': triggered,
        'notification_sent': notification_sent
    })

# ---------------- CRUD ----------------
@login_required_dynamodb
def item_list(request):
    resp = inventory_table.scan()
    items = resp.get('Items', [])
    return render(request, 'item_list.html', {'items': items})

@login_required_dynamodb
def item_create(request):
    if request.method == 'POST':
        item_id = request.POST.get('item_id', '').strip()
        name = request.POST.get('name', '').strip()
        quantity = int(request.POST.get('quantity', 0))
        threshold = int(request.POST.get('threshold', 0))
        min_required = int(request.POST.get('min_required', 0))
        max_capacity = int(request.POST.get('max_capacity', 0))
        monthly_sales = int(request.POST.get('monthly_sales', 0))
        next_shipment_days = int(request.POST.get('next_shipment_days', 0))

        expiry_date_str = request.POST.get('expiry_date', '').strip()
        expiry_days = None

        if expiry_date_str:
            try:
                expiry_dt = datetime.strptime(expiry_date_str, '%Y-%m-%d').date()
                expiry_days = (expiry_dt - date.today()).days
            except Exception:
                expiry_days = None

        item_data = {
            'item_id': item_id,
            'name': name,
            'quantity': quantity,
            'threshold': threshold,
            'min_required': min_required,
            'max_capacity': max_capacity,
            'monthly_sales': monthly_sales,
            'next_shipment_days': next_shipment_days
        }

        if expiry_date_str:
            item_data['expiry_date'] = expiry_date_str
            if expiry_days is not None:
                item_data['expiry_days'] = expiry_days

        image = request.FILES.get('image')
        if image:
            try:
                item_data['image_url'] = upload_to_s3(image, image.name)
            except Exception as e:
                messages.warning(request, f"S3 upload failed: {e}")

        try:
            inventory_table.put_item(Item=item_data)
            messages.success(request, f"Item {item_id} created.")
            user_obj = User.objects.get(username=request.session.get('username'))
            log_action_sqlite(user_obj, 'create_item', item_id)
            return redirect('item_list')
        except Exception as e:
            messages.error(request, f"Failed to create item: {e}")
            return render(request, 'item_form.html', {'item': item_data})

    return render(request, 'item_form.html')

@login_required_dynamodb
def item_update(request, pk):
    pk = str(pk)
    resp = inventory_table.get_item(Key={'item_id': pk})
    item = resp.get('Item') if isinstance(resp, dict) else None

    if not isinstance(item, dict):
        messages.error(request, f"Item {pk} not found.")
        return redirect('item_list')

    if request.method == 'POST':
        name = request.POST.get('name', '').strip()
        quantity = int(request.POST.get('quantity', 0))
        threshold = int(request.POST.get('threshold', 0))
        min_required = int(request.POST.get('min_required', 0))
        max_capacity = int(request.POST.get('max_capacity', 0))
        monthly_sales = int(request.POST.get('monthly_sales', 0))
        next_shipment_days = int(request.POST.get('next_shipment_days', 0))

        expiry_date_str = request.POST.get('expiry_date', '').strip()
        expiry_days = None

        if expiry_date_str:
            try:
                expiry_dt = datetime.strptime(expiry_date_str, '%Y-%m-%d').date()
                expiry_days = (expiry_dt - date.today()).days
            except Exception:
                expiry_days = None

        updated = {
            'item_id': pk,
            'name': name,
            'quantity': quantity,
            'threshold': threshold,
            'min_required': min_required,
            'max_capacity': max_capacity,
            'monthly_sales': monthly_sales,
            'next_shipment_days': next_shipment_days
        }

        if expiry_date_str:
            updated['expiry_date'] = expiry_date_str
            if expiry_days is not None:
                updated['expiry_days'] = expiry_days

        image = request.FILES.get('image')
        if image:
            try:
                updated['image_url'] = upload_to_s3(image, image.name)
            except Exception:
                pass

        inventory_table.put_item(Item=updated)
        messages.success(request, f"Item {pk} updated.")

        user_obj = User.objects.get(username=request.session.get('username'))
        log_action_sqlite(user_obj, 'update_item', pk)

        return redirect('item_list')

    return render(request, 'item_form.html', {'item': item})

@login_required_dynamodb
def item_delete(request, pk):
    pk = str(pk)
    inventory_table.delete_item(Key={'item_id': pk})

    messages.success(request, f"Item {pk} deleted.")
    user_obj = User.objects.get(username=request.session.get('username'))
    log_action_sqlite(user_obj, 'delete_item', pk)

    return redirect('item_list')
