from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import login, logout
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.core.exceptions import PermissionDenied
from django.db import transaction
from django.utils import timezone
from datetime import date, timedelta
import boto3
import json
import os

# Import your new PyPI library
from rentclc import RentCalculator

from .models import User, Property, TenancyApplication, Tenancy, Payment, Notification
from .forms import (
    UserRegisterForm, LoginForm, PropertyForm, PropertyImageFormSet,
    ApplicationForm, TenancyForm, PaymentForm, NotificationForm,
    MaintenanceTicketForm, TenantRegisterForm, LandlordRegisterForm
)

AWS_SNS_TOPIC_ARN = "arn:aws:sns:us-east-1:941052463179:rms-notifications"
AWS_S3_REGION_NAME = "us-east-1"


# ----------------------------------
# HOME
# ----------------------------------
def home(request):
    properties = Property.objects.all().order_by('-created_at')[:9]
    return render(request, 'rentals/home.html', {'properties': properties})


# ----------------------------------
# AUTH VIEWS
# ----------------------------------
def register_view(request):
    if request.method == 'POST':
        form = UserRegisterForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user)
            messages.success(request, 'Registration successful.')
            if user.is_landlord:
                return redirect('landlord_dashboard')
            elif user.is_tenant:
                return redirect('tenant_dashboard')
            return redirect('home')
    else:
        form = UserRegisterForm()
    return render(request, 'rentals/register.html', {'form': form})


def login_view(request):
    if request.method == 'POST':
        form = LoginForm(request, data=request.POST)
        if form.is_valid():
            user = form.get_user()
            login(request, user)
            messages.success(request, 'Logged in successfully.')
            if user.is_landlord:
                return redirect('landlord_dashboard')
            elif user.is_tenant:
                return redirect('tenant_dashboard')
            return redirect('home')
    else:
        form = LoginForm()
    return render(request, 'rentals/login.html', {'form': form})


def logout_view(request):
    logout(request)
    messages.info(request, 'You have been logged out.')
    return redirect('home')


# ----------------------------------
# PROPERTY VIEWS
# ----------------------------------
def property_list(request):
    properties = Property.objects.select_related('landlord').order_by('-created_at')
    return render(request, 'rentals/property_list.html', {'properties': properties})


def property_detail(request, pk):
    prop = get_object_or_404(Property.objects.select_related('landlord'), pk=pk)

    app_form = None
    tenancy_form = None

    if request.user.is_authenticated and request.user.is_tenant:
        app_form = ApplicationForm()
        tenancy_form = TenancyForm()

    return render(request, 'rentals/property_detail.html', {
        'property': prop,
        'app_form': app_form,
        'tenancy_form': tenancy_form,
    })


@login_required
def landlord_dashboard(request):
    if not request.user.is_landlord:
        raise PermissionDenied("Only landlords can access this page.")

    properties = request.user.properties.all().order_by('-created_at')

    applications = TenancyApplication.objects.filter(
        property__landlord=request.user,
        status='pending'
    ).select_related('tenant', 'property').order_by('-created_at')

    notifications = Notification.objects.filter(
        recipient=request.user
    ).order_by('-created_at')[:10]

    return render(request, 'rentals/landlord_dashboard.html', {
        'properties': properties,
        'applications': applications,
        'notifications': notifications
    })


# ----------------------------------
# PROPERTY CREATE/UPDATE/DELETE
# ----------------------------------
@login_required
def property_create(request):
    if not request.user.is_landlord:
        raise PermissionDenied

    if request.method == 'POST':
        form = PropertyForm(request.POST)
        formset = PropertyImageFormSet(request.POST, request.FILES)
        if form.is_valid() and formset.is_valid():
            with transaction.atomic():
                prop = form.save(commit=False)
                prop.landlord = request.user
                prop.save()
                formset.instance = prop
                formset.save()
            messages.success(request, 'Property created successfully.')
            return redirect('landlord_dashboard')
    else:
        form = PropertyForm()
        formset = PropertyImageFormSet()

    return render(request, 'rentals/property_form.html', {
        'form': form,
        'formset': formset,
        'create': True
    })


@login_required
def property_update(request, pk):
    if not request.user.is_landlord:
        raise PermissionDenied
    prop = get_object_or_404(Property, pk=pk, landlord=request.user)

    if request.method == 'POST':
        form = PropertyForm(request.POST, instance=prop)
        formset = PropertyImageFormSet(request.POST, request.FILES, instance=prop)
        if form.is_valid() and formset.is_valid():
            with transaction.atomic():
                form.save()
                formset.save()
            messages.success(request, 'Property updated successfully.')
            return redirect('landlord_dashboard')
    else:
        form = PropertyForm(instance=prop)
        formset = PropertyImageFormSet(instance=prop)

    return render(request, 'rentals/property_form.html', {
        'form': form,
        'formset': formset,
        'create': False
    })


@login_required
def property_delete(request, pk):
    if not request.user.is_landlord:
        raise PermissionDenied
    prop = get_object_or_404(Property, pk=pk, landlord=request.user)
    prop.delete()
    messages.info(request, 'Property deleted.')
    return redirect('landlord_dashboard')


# ----------------------------------
# TENANCY APPLICATION
# ----------------------------------
@login_required
def apply_property(request, property_id):
    if not request.user.is_tenant:
        raise PermissionDenied

    prop = get_object_or_404(Property, pk=property_id)

    if request.method == 'POST':
        form = ApplicationForm(request.POST)
        if form.is_valid():

            application = TenancyApplication.objects.create(
                tenant=request.user,
                property=prop,
                message=form.cleaned_data['message'],
                status='pending'
            )

            Notification.objects.create(
                sender=request.user,
                recipient=prop.landlord,
                message=f"{request.user.username} submitted an application for {prop.title}."
            )

            messages.success(request, 'Application submitted.')
    return redirect('property_detail', pk=property_id)


@login_required
def application_list(request):
    if not request.user.is_landlord:
        raise PermissionDenied

    applications = TenancyApplication.objects.filter(
        property__landlord=request.user
    ).select_related('tenant', 'property').order_by('-created_at')

    return render(request, 'rentals/application_list.html', {'applications': applications})


@login_required
def application_approve(request, pk):
    if not request.user.is_landlord:
        raise PermissionDenied

    application = get_object_or_404(
        TenancyApplication,
        pk=pk,
        property__landlord=request.user
    )

    application.status = 'approved'
    application.save()

    # Create tenancy automatically
    tenancy, created = Tenancy.objects.get_or_create(
        tenant=application.tenant,
        property=application.property,
        start_date=date.today(),
        end_date=date.today() + timedelta(days=365),
        defaults={'active': True}
    )

    # Calculate total rent & save inside tenancy
    if created:
        total_rent = RentCalculator.auto_calculate(
            rate=tenancy.property.rent_amount,
            rate_type="monthly",
            start_date=tenancy.start_date,
            end_date=tenancy.end_date
        )

        tenancy.total_rent = total_rent
        tenancy.save()

    messages.success(request, f'Application approved. Total Rent = {tenancy.total_rent}')
    return redirect('application_list')


@login_required
def application_reject(request, pk):
    if not request.user.is_landlord:
        raise PermissionDenied

    application = get_object_or_404(
        TenancyApplication,
        pk=pk,
        property__landlord=request.user
    )

    application.status = 'rejected'
    application.save()

    messages.info(request, 'Application rejected.')
    return redirect('application_list')


# ----------------------------------
# PAYMENTS
# ----------------------------------
@login_required
def payments_view(request, tenancy_id):
    tenancy = get_object_or_404(Tenancy, pk=tenancy_id)
    if request.user != tenancy.tenant and request.user != tenancy.property.landlord:
        raise PermissionDenied

    # Ensure rent is calculated
    total_rent = RentCalculator.auto_calculate(
        rate=tenancy.property.rent_amount,
        rate_type="monthly",
        start_date=tenancy.start_date,
        end_date=tenancy.end_date
    )

    payments = tenancy.payments.order_by('-date')

    return render(request, 'rentals/payments.html', {
        'tenancy': tenancy,
        'payments': payments,
        'total_rent': total_rent,
    })


@login_required
def payment_create(request, tenancy_id):
    tenancy = get_object_or_404(Tenancy, pk=tenancy_id)

    if not request.user.is_tenant or request.user != tenancy.tenant:
        raise PermissionDenied

    if request.method == 'POST':
        form = PaymentForm(request.POST)
        if form.is_valid():
            payment = form.save(commit=False)
            payment.tenancy = tenancy
            payment.paid_by_tenant = True
            payment.save()

            messages.success(request, 'Payment recorded.')
            return redirect('payments', tenancy_id=tenancy.id)
    else:
        form = PaymentForm()

    return render(request, 'rentals/payment_form.html', {'form': form, 'tenancy': tenancy})


# ----------------------------------
# MAINTENANCE TICKETS
# ----------------------------------
@login_required
def tickets_view(request):
    if not request.user.is_tenant and not request.user.is_landlord:
        raise PermissionDenied

    if request.user.is_tenant:
        tenancies = request.user.tenancies.all()
    else:
        tenancies = Tenancy.objects.filter(property__landlord=request.user)

    tickets = []
    for t in tenancies:
        tickets.extend(list(t.tickets.all()))

    tickets = sorted(tickets, key=lambda x: x.created_at, reverse=True)

    return render(request, 'rentals/tickets.html', {'tickets': tickets})


@login_required
def ticket_create(request, tenancy_id):
    tenancy = get_object_or_404(Tenancy, pk=tenancy_id)

    if not request.user.is_tenant or tenancy.tenant != request.user:
        raise PermissionDenied

    if request.method == 'POST':
        form = MaintenanceTicketForm(request.POST)
        if form.is_valid():
            ticket = form.save(commit=False)
            ticket.tenancy = tenancy
            ticket.save()

            messages.success(request, 'Maintenance ticket created.')
            return redirect('tickets')
    else:
        form = MaintenanceTicketForm()

    return render(request, 'rentals/ticket_form.html', {'form': form, 'tenancy': tenancy})


# ----------------------------------
# USER REGISTRATION (LANDLORD / TENANT)
# ----------------------------------
def landlord_register_view(request):
    if request.method == 'POST':
        form = LandlordRegisterForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user)
            messages.success(request, 'Landlord account created.')
            return redirect('landlord_dashboard')
    else:
        form = LandlordRegisterForm()
    return render(request, 'rentals/landlord_register.html', {'form': form})


def tenant_register_view(request):
    if request.method == 'POST':
        form = TenantRegisterForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user)
            messages.success(request, 'Tenant account created.')
            return redirect('tenant_dashboard')
    else:
        form = TenantRegisterForm()
    return render(request, 'rentals/tenant_register.html', {'form': form})


# ----------------------------------
# NOTIFICATIONS
# ----------------------------------
@login_required
def notifications_view(request):
    sent = Notification.objects.filter(sender=request.user).order_by('-created_at')
    received = Notification.objects.filter(recipient=request.user).order_by('-created_at')

    return render(request, 'rentals/notifications.html', {
        'sent': sent,
        'received': received
    })


@login_required
def notification_create(request):
    if not request.user.is_landlord:
        raise PermissionDenied

    form = NotificationForm()
    form.fields['recipient'].queryset = User.objects.filter(is_tenant=True)

    if request.method == 'POST':
        form = NotificationForm(request.POST)
        form.fields['recipient'].queryset = User.objects.filter(is_tenant=True)

        if form.is_valid():
            notif = form.save(commit=False)
            notif.sender = request.user
            notif.save()

            try:
                sns_client = boto3.client('sns', region_name=AWS_S3_REGION_NAME)
                message = json.dumps({
                    "sender": request.user.username,
                    "recipient": notif.recipient.username,
                    "body": notif.message
                })
                sns_client.publish(
                    TopicArn=AWS_SNS_TOPIC_ARN,
                    Message=message,
                    Subject="RentalSys Notification"
                )
            except Exception as e:
                messages.warning(request, f'Notification saved but SNS publish failed: {e}')

            messages.success(request, 'Notification sent.')
            return redirect('notifications')

    return render(request, 'rentals/notification_form.html', {'form': form})


# ----------------------------------
# TENANT DASHBOARD
# ----------------------------------
@login_required
def tenant_dashboard(request):
    if not request.user.is_tenant:
        raise PermissionDenied

    for t in request.user.tenancies.all():
        t.check_and_expire()

    tenancies = request.user.tenancies.select_related('property').order_by('-created_at')

    # Add total rent to each tenancy
    for tenancy in tenancies:
        tenancy.total_rent = RentCalculator.auto_calculate(
            rate=float(tenancy.property.rent_amount),
            rate_type="monthly",
            start_date=tenancy.start_date,
            end_date=tenancy.end_date
        )

    notifications = Notification.objects.filter(recipient=request.user).order_by('-created_at')[:10]

    return render(request, 'rentals/tenant_dashboard.html', {
        'tenancies': tenancies,
        'notifications': notifications
    })
